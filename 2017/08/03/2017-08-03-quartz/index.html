<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="陶陶滔滔涛的博客">
    <meta name="keyword" content="陶陶滔滔涛, ruitao, Java">
    <meta name="theme-color" content="#600090">
    <meta name="msapplication-navbutton-color" content="#600090">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="#600090">
    <link rel="shortcut icon" href="https://cdn4.iconfinder.com/data/icons/ionicons/512/icon-person-128.png">
    <link rel="alternate" type="application/atom+xml" title="陶陶滔滔涛" href="/atom.xml">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css">
    <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.css">
    <title>
        
        Quartz基础知识及源码分享｜陶陶滔滔涛的博客
        
    </title>

    <link rel="canonical" href="http://ruitao.name/2017/08/03/2017-08-03-quartz/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/blog-style.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">
</head>

<style>

    header.intro-header {
        background-image: url('//oco8bvfr8.qnssl.com/16-8-new-bg.jpg?imageView2/1/w/800/h/300/interlace/1/q/80')
    }
</style>
<!-- hack iOS CSS :active style -->
<body ontouchstart="" class="animated fadeIn">
<!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top " id="nav-top" data-ispost = "true" data-istags="false
" data-ishome = "false" >
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand animated pulse" href="/">
                <span class="brand-logo">
                    陶陶滔滔涛
                </span>
                的博客
            </a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <!-- /.navbar-collapse -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">首页</a>
                    </li>
					
                    
                        
							
                        <li>
                            <a href="/tags/">标签</a>
                        </li>
							
						
                    
					
					
                </ul>
            </div>
        </div>
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
//    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>

<!-- Main Content -->

<!--only post-->


<img class="wechat-title-img"
     src="//oco8bvfr8.qnssl.com/16-8-new-bg.jpg?imageView2/1/w/800/h/300/interlace/1/q/80">


<style>
    
    header.intro-header {
        background-image: url('//oco8bvfr8.qnssl.com/16-8-new-bg.jpg?imageView2/1/w/800/h/300/interlace/1/q/80')
    }

    
</style>

<header class="intro-header">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 text-center">
                <div class="post-heading">
                    <h1>Quartz基础知识及源码分享</h1>
                    
                    <span class="meta">
                         作者 陶陶滔滔涛
                        <span>
                          日期 2017-08-03
                         </span>
                    </span>
                    <div class="tags text-center">
                        
                        <a class="tag" href="/tags/#Java"
                           title="Java">Java</a>
                        
                        <a class="tag" href="/tags/#quartz"
                           title="quartz">quartz</a>
                        
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="post-title-haojen">
        <span>
            Quartz基础知识及源码分享
        </span>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <!-- Post Container -->
            <div class="col-lg-8 col-lg-offset-1 col-sm-9 post-container">
                <p>我们的Quartz是依赖MySQL库的集群模式执行。此篇基于Quartz2.2.1源码。</p>
<h2 id="Quartz状态解析"><a href="#Quartz状态解析" class="headerlink" title="Quartz状态解析"></a>Quartz状态解析</h2><p>在以前的AMP以及现在的KAKA中quartz模块（内部监控系统），我们经常会看到状态栏会展示出WAITING， ACQUIRED，BLOCKED，PAUSED等状态，这些状态的含义是什么呢？</p>
<ul>
<li>WAITING：等待执行状态，此时还没有任何机器调度到此定时任务。</li>
<li>ACQUIRED：已被某台机器锁定，即将执行。</li>
<li>BLOCKED：定时任务执行中，防止其他机器执行。</li>
<li>PAUSED：暂停状态，定时任务不会被调度。</li>
</ul>
<h2 id="核心表解析"><a href="#核心表解析" class="headerlink" title="核心表解析"></a>核心表解析</h2><ul>
<li>qrtz_triggers：触发器信息存储表，记录了触发器组，名称，任务组，名称，创建时间，描述，下次执行时间，上次执行时间，触发器状态等信息。</li>
<li>qrtz_cron_triggers：cron触发器的表达式存储在这里。</li>
<li>qrtz_fired_triggers：即将执行和正在执行的定时任务存放处，存放执行机器信息，执行时间，状态等。<br>这个表里面的状态只有两个，ACQUIRED和EXECUTING。ACCQUIRED对应qrtz_triggers表中的ACCQUIRED状态，EXECUTING对应其中的BLOCKED状态。</li>
<li>qrtz_locks：Quartz锁存放表，1.8.6之前只有一列，即锁名称，2.0之后有两列，增加了SCHED_NAME，对应相对应的业务集群，很好地解决了几十几百台机器争抢同一把锁的死锁问题。</li>
<li>qrtz_scheduler_state：调度示例（业务机器）状态，存放扫描间隔，上次扫描时间等信息。</li>
</ul>
<h2 id="Dubbo调度方式解析"><a href="#Dubbo调度方式解析" class="headerlink" title="Dubbo调度方式解析"></a>Dubbo调度方式解析</h2><p>在dubbo中，我们通过dubbo的container机制实现了调度示例的初始化工作，详情参考如下代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.asura.framework.dubbo.container;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.text.SimpleDateFormat;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.quartz.Scheduler;</span><br><span class="line"><span class="keyword">import</span> org.quartz.SchedulerException;</span><br><span class="line"><span class="keyword">import</span> org.quartz.SchedulerFactory;</span><br><span class="line"><span class="keyword">import</span> org.quartz.impl.StdSchedulerFactory;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.container.Container;</span><br><span class="line"><span class="keyword">import</span> com.asura.framework.base.exception.BusinessException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SchedulerContainer</span> <span class="keyword">implements</span> <span class="title">Container</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(SfbestSchedulerContainer.class);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Scheduler</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> Scheduler scheduler;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 启动QuartzScheduler</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> BusinessException </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			SchedulerFactory sf = <span class="keyword">new</span> StdSchedulerFactory(<span class="string">"quartz.properties"</span>);</span><br><span class="line">			scheduler = sf.getScheduler();</span><br><span class="line">			scheduler.start();</span><br><span class="line">			logger.info(<span class="keyword">new</span> SimpleDateFormat(<span class="string">"[yyyy-MM-dd HH:mm:ss]"</span>).format(<span class="keyword">new</span> Date()) + <span class="string">" Quartz started!"</span>);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (SchedulerException e) &#123;</span><br><span class="line">			logger.error(<span class="string">"启动Quartz出错:"</span> + e.getMessage(), e.getCause());</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> BusinessException(e.getMessage(), e.getCause());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 停止QuartzScheduler</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> <span class="keyword">throws</span> BusinessException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">null</span> != scheduler) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				scheduler.shutdown();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (SchedulerException e) &#123;</span><br><span class="line">				logger.error(<span class="string">"停止Quartz出错:"</span> + e.getMessage(), e.getCause());</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> BusinessException(e.getMessage(), e.getCause());</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在asura-dubbo项目中，我们为此container指定了一个名称：</p>
<p>scheduler=com.asura.framework.dubbo.container.SchedulerContainer</p>
<p>最终我们只需要在dubbo.properties中将此scheduler配置在container部分即可，同样的实现参考dubbo-cat。</p>
<h2 id="Quartz核心业务逻辑解析"><a href="#Quartz核心业务逻辑解析" class="headerlink" title="Quartz核心业务逻辑解析"></a>Quartz核心业务逻辑解析</h2><ol>
<li>启动Quartz中的调度器，代码参考上方asura的启动方式。</li>
<li>调度器启动一个线程（QuartzScheduler.java）不断地去尝试获取即将执行的定时任务。</li>
<li>以锁的方式获取到本实例需要执行的一批定时任务（由当前空闲线程决定获取的多少），并将trigger状态改为ACQUIRED，将待执行的定时任务插入到fired_triggers表。</li>
<li>等待最近的一个定时任务时间间隔（Thread.sleep）后，将定时任务置为触发状态，并触发JobRunShell（JobRunShell.java）执行定时任务。</li>
<li>执行完毕后，将定时任务置为完成，从fired_triggers中删除。</li>
</ol>
<h2 id="我们的优化"><a href="#我们的优化" class="headerlink" title="我们的优化"></a>我们的优化</h2><ol>
<li>采取了druid数据源替代默认的DHCP数据源</li>
<li>记录定时任务的开始结束时间</li>
<li>支持动态参数配置执行</li>
</ol>
<h2 id="核心代码解析"><a href="#核心代码解析" class="headerlink" title="核心代码解析"></a>核心代码解析</h2><figure class="highlight java"><figcaption><span>QuartzScheduler.java</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment">// 初始化线程调度器</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">QuartzScheduler</span><span class="params">(QuartzSchedulerResources resources, <span class="keyword">long</span> idleWaitTime, @Deprecated <span class="keyword">long</span> dbRetryInterval)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> SchedulerException </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.resources = resources;</span><br><span class="line">    <span class="keyword">if</span> (resources.getJobStore() <span class="keyword">instanceof</span> JobListener) &#123;</span><br><span class="line">        addInternalJobListener((JobListener)resources.getJobStore());</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    <span class="comment">// 启动线程执行调度核心内容</span></span><br><span class="line">    <span class="keyword">this</span>.schedThread = <span class="keyword">new</span> QuartzSchedulerThread(<span class="keyword">this</span>, resources);</span><br><span class="line">    ThreadExecutor schedThreadExecutor = resources.getThreadExecutor();</span><br><span class="line">    schedThreadExecutor.execute(<span class="keyword">this</span>.schedThread);</span><br><span class="line">    <span class="keyword">if</span> (idleWaitTime &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.schedThread.setIdleWaitTime(idleWaitTime);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    jobMgr = <span class="keyword">new</span> ExecutingJobsManager();</span><br><span class="line">    addInternalJobListener(jobMgr);</span><br><span class="line">    errLogger = <span class="keyword">new</span> ErrorLogger();</span><br><span class="line">    addInternalSchedulerListener(errLogger);</span><br><span class="line"> </span><br><span class="line">    signaler = <span class="keyword">new</span> SchedulerSignalerImpl(<span class="keyword">this</span>, <span class="keyword">this</span>.schedThread);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span>(shouldRunUpdateCheck())</span><br><span class="line">        updateTimer = scheduleUpdateCheck();</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        updateTimer = <span class="keyword">null</span>;</span><br><span class="line"> </span><br><span class="line">    getLog().info(<span class="string">"Quartz Scheduler v."</span> + getVersion() + <span class="string">" created."</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 启动线程调度器进行检查，未完成定时任务扫描等</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> SchedulerException </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (shuttingDown|| closed) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SchedulerException(</span><br><span class="line">                <span class="string">"The Scheduler cannot be restarted after shutdown() has been called."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// QTZ-212 : calling new schedulerStarting() method on the listeners</span></span><br><span class="line">    <span class="comment">// right after entering start()</span></span><br><span class="line">    notifySchedulerListenersStarting();</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 启动定时任务</span></span><br><span class="line">    <span class="keyword">if</span> (initialStart == <span class="keyword">null</span>) &#123;</span><br><span class="line">        initialStart = <span class="keyword">new</span> Date();</span><br><span class="line">        <span class="keyword">this</span>.resources.getJobStore().schedulerStarted();</span><br><span class="line">        startPlugins();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        resources.getJobStore().schedulerResumed();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    schedThread.togglePause(<span class="keyword">false</span>);</span><br><span class="line"> </span><br><span class="line">    getLog().info(</span><br><span class="line">            <span class="string">"Scheduler "</span> + resources.getUniqueIdentifier() + <span class="string">" started."</span>);</span><br><span class="line"> </span><br><span class="line">    notifySchedulerListenersStarted();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><figcaption><span>JobStoreSupport.java</span></figcaption><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 调度任务启动方法</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">schedulerStarted</span><span class="params">()</span> <span class="keyword">throws</span> SchedulerException </span>&#123;</span><br><span class="line">     </span><br><span class="line">    <span class="comment">// 集群模式，启动集群扫描</span></span><br><span class="line">    <span class="keyword">if</span> (isClustered()) &#123;</span><br><span class="line">        clusterManagementThread = <span class="keyword">new</span> ClusterManager();</span><br><span class="line">        <span class="keyword">if</span>(initializersLoader != <span class="keyword">null</span>)</span><br><span class="line">            clusterManagementThread.setContextClassLoader(initializersLoader);</span><br><span class="line">        clusterManagementThread.initialize();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            recoverJobs();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SchedulerException se) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SchedulerConfigException(</span><br><span class="line">                    <span class="string">"Failure occured during job recovery."</span>, se);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 未完成，错过定时任务扫描</span></span><br><span class="line">    misfireHandler = <span class="keyword">new</span> MisfireHandler();</span><br><span class="line">    <span class="keyword">if</span>(initializersLoader != <span class="keyword">null</span>)</span><br><span class="line">        misfireHandler.setContextClassLoader(initializersLoader);</span><br><span class="line">    misfireHandler.initialize();</span><br><span class="line">    schedulerRunning = <span class="keyword">true</span>;</span><br><span class="line"> </span><br><span class="line">    getLog().debug(<span class="string">"JobStore background threads started (as scheduler was started)."</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 获取即将执行的定时任务</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> List&lt;OperableTrigger&gt; <span class="title">acquireNextTrigger</span><span class="params">(Connection conn, <span class="keyword">long</span> noLaterThan, <span class="keyword">int</span> maxCount, <span class="keyword">long</span> timeWindow)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> JobPersistenceException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (timeWindow &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    List&lt;OperableTrigger&gt; acquiredTriggers = <span class="keyword">new</span> ArrayList&lt;OperableTrigger&gt;();</span><br><span class="line">    Set&lt;JobKey&gt; acquiredJobKeysForNoConcurrentExec = <span class="keyword">new</span> HashSet&lt;JobKey&gt;();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> MAX_DO_LOOP_RETRY = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">int</span> currentLoopCount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">long</span> firstAcquiredTriggerFireTime = <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        currentLoopCount ++;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// SQL执行查询</span></span><br><span class="line">            List&lt;TriggerKey&gt; keys = getDelegate().selectTriggerToAcquire(conn, noLaterThan + timeWindow, getMisfireTime(), maxCount);</span><br><span class="line"> </span><br><span class="line">            <span class="comment">// 没有抓取到，直接返回</span></span><br><span class="line">            <span class="keyword">if</span> (keys == <span class="keyword">null</span> || keys.size() == <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> acquiredTriggers;</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">for</span>(TriggerKey triggerKey: keys) &#123;</span><br><span class="line"> </span><br><span class="line">                <span class="comment">// 查看业务系统是否存在相对应的trigger，不存在，不处理</span></span><br><span class="line">                String jobClass = getDelegate().selectJobClassForTrigger(conn, triggerKey.getName(), triggerKey.getGroup());</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    getClassLoadHelper().loadClass(jobClass);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"> </span><br><span class="line">                <span class="comment">// 抓取单个trigger，查看是否存在</span></span><br><span class="line">                OperableTrigger nextTrigger = retrieveTrigger(conn, triggerKey);</span><br><span class="line">                <span class="keyword">if</span>(nextTrigger == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>; <span class="comment">// next trigger</span></span><br><span class="line">                &#125;</span><br><span class="line"> </span><br><span class="line">                <span class="comment">// If trigger's job is set as @DisallowConcurrentExecution, and it has already been added to result, then</span></span><br><span class="line">                <span class="comment">// put it back into the timeTriggers set and continue to search for next trigger.</span></span><br><span class="line">                JobKey jobKey = nextTrigger.getJobKey();</span><br><span class="line">                JobDetail job = getDelegate().selectJobDetail(conn, jobKey, getClassLoadHelper());</span><br><span class="line">                <span class="keyword">if</span> (job.isConcurrentExectionDisallowed()) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (acquiredJobKeysForNoConcurrentExec.contains(jobKey)) &#123;</span><br><span class="line">                        <span class="keyword">continue</span>; <span class="comment">// next trigger</span></span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        acquiredJobKeysForNoConcurrentExec.add(jobKey);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"> </span><br><span class="line">                <span class="comment">// 更新trigger状态为ACQUIRED</span></span><br><span class="line">                <span class="keyword">int</span> rowsUpdated = getDelegate().updateTriggerStateFromOtherState(conn, triggerKey, STATE_ACQUIRED, STATE_WAITING);</span><br><span class="line">                <span class="keyword">if</span> (rowsUpdated &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>; <span class="comment">// next trigger</span></span><br><span class="line">                &#125;</span><br><span class="line"> </span><br><span class="line">                <span class="comment">// 插入到fired_triggers表</span></span><br><span class="line">                nextTrigger.setFireInstanceId(getFiredTriggerRecordId());</span><br><span class="line">                getDelegate().insertFiredTrigger(conn, nextTrigger, STATE_ACQUIRED, <span class="keyword">null</span>);</span><br><span class="line"> </span><br><span class="line">                acquiredTriggers.add(nextTrigger);</span><br><span class="line">                <span class="keyword">if</span>(firstAcquiredTriggerFireTime == <span class="number">0</span>)</span><br><span class="line">                    firstAcquiredTriggerFireTime = nextTrigger.getNextFireTime().getTime();</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            <span class="comment">// 如果没有任何即将执行的信息，再次重试三次</span></span><br><span class="line">            <span class="keyword">if</span>(acquiredTriggers.size() == <span class="number">0</span> &amp;&amp; currentLoopCount &lt; MAX_DO_LOOP_RETRY) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            <span class="comment">// We are done with the while loop.</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JobPersistenceException(</span><br><span class="line">                      <span class="string">"Couldn't acquire next trigger: "</span> + e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (<span class="keyword">true</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// Return the acquired trigger list</span></span><br><span class="line">    <span class="keyword">return</span> acquiredTriggers;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 将定时任务改为触发状态</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> TriggerFiredBundle <span class="title">triggerFired</span><span class="params">(Connection conn,</span></span></span><br><span class="line"><span class="function"><span class="params">        OperableTrigger trigger)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> JobPersistenceException </span>&#123;</span><br><span class="line">    JobDetail job;</span><br><span class="line">    Calendar cal = <span class="keyword">null</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 查看当前trigger状态，如果不是STATE_ACQUIRED，结束</span></span><br><span class="line">    <span class="keyword">try</span> &#123; <span class="comment">// if trigger was deleted, state will be STATE_DELETED</span></span><br><span class="line">        String state = getDelegate().selectTriggerState(conn,</span><br><span class="line">                trigger.getKey());</span><br><span class="line">        <span class="keyword">if</span> (!state.equals(STATE_ACQUIRED)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> JobPersistenceException(<span class="string">"Couldn't select trigger state: "</span></span><br><span class="line">                + e.getMessage(), e);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        job = retrieveJob(conn, trigger.getJobKey());</span><br><span class="line">        <span class="keyword">if</span> (job == <span class="keyword">null</span>) &#123; <span class="keyword">return</span> <span class="keyword">null</span>; &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (JobPersistenceException jpe) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            getLog().error(<span class="string">"Error retrieving job, setting trigger state to ERROR."</span>, jpe);</span><br><span class="line">            getDelegate().updateTriggerState(conn, trigger.getKey(),</span><br><span class="line">                    STATE_ERROR);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException sqle) &#123;</span><br><span class="line">            getLog().error(<span class="string">"Unable to set trigger state to ERROR."</span>, sqle);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> jpe;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (trigger.getCalendarName() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        cal = retrieveCalendar(conn, trigger.getCalendarName());</span><br><span class="line">        <span class="keyword">if</span> (cal == <span class="keyword">null</span>) &#123; <span class="keyword">return</span> <span class="keyword">null</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 将fired_triggers中状态改为EXECUTING</span></span><br><span class="line">        getDelegate().updateFiredTrigger(conn, trigger, STATE_EXECUTING, job);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> JobPersistenceException(<span class="string">"Couldn't insert fired trigger: "</span></span><br><span class="line">                + e.getMessage(), e);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    Date prevFireTime = trigger.getPreviousFireTime();</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// call triggered - to update the trigger's next-fire-time state...</span></span><br><span class="line">    trigger.triggered(cal);</span><br><span class="line"> </span><br><span class="line">    String state = STATE_WAITING;</span><br><span class="line">    <span class="keyword">boolean</span> force = <span class="keyword">true</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (job.isConcurrentExectionDisallowed()) &#123;</span><br><span class="line">        state = STATE_BLOCKED;</span><br><span class="line">        force = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 更新triggers表状态为BLOCKED</span></span><br><span class="line">            getDelegate().updateTriggerStatesForJobFromOtherState(conn, job.getKey(),</span><br><span class="line">                    STATE_BLOCKED, STATE_WAITING);</span><br><span class="line">            getDelegate().updateTriggerStatesForJobFromOtherState(conn, job.getKey(),</span><br><span class="line">                    STATE_BLOCKED, STATE_ACQUIRED);</span><br><span class="line">            getDelegate().updateTriggerStatesForJobFromOtherState(conn, job.getKey(),</span><br><span class="line">                    STATE_PAUSED_BLOCKED, STATE_PAUSED);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JobPersistenceException(</span><br><span class="line">                    <span class="string">"Couldn't update states of blocked triggers: "</span></span><br><span class="line">                            + e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (trigger.getNextFireTime() == <span class="keyword">null</span>) &#123;</span><br><span class="line">        state = STATE_COMPLETE;</span><br><span class="line">        force = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    <span class="comment">// 更新调度时间后，重新保存定时任务</span></span><br><span class="line">    storeTrigger(conn, trigger, job, <span class="keyword">true</span>, state, force, <span class="keyword">false</span>);</span><br><span class="line"> </span><br><span class="line">    job.getJobDataMap().clearDirtyFlag();</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> TriggerFiredBundle(job, trigger, cal, trigger.getKey().getGroup()</span><br><span class="line">            .equals(Scheduler.DEFAULT_RECOVERY_GROUP), <span class="keyword">new</span> Date(), trigger</span><br><span class="line">            .getPreviousFireTime(), prevFireTime, trigger.getNextFireTime());</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 完成定时任务</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">triggeredJobComplete</span><span class="params">(Connection conn,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    OperableTrigger trigger, JobDetail jobDetail,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    CompletedExecutionInstruction triggerInstCode)</span> <span class="keyword">throws</span> JobPersistenceException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (triggerInstCode == CompletedExecutionInstruction.DELETE_TRIGGER) &#123;</span><br><span class="line">            <span class="keyword">if</span>(trigger.getNextFireTime() == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// double check for possible reschedule within job</span></span><br><span class="line">                <span class="comment">// execution, which would cancel the need to delete...</span></span><br><span class="line">                TriggerStatus stat = getDelegate().selectTriggerStatus(</span><br><span class="line">                        conn, trigger.getKey());</span><br><span class="line">                <span class="keyword">if</span>(stat != <span class="keyword">null</span> &amp;&amp; stat.getNextFireTime() == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    removeTrigger(conn, trigger.getKey());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">                removeTrigger(conn, trigger.getKey());</span><br><span class="line">                signalSchedulingChangeOnTxCompletion(<span class="number">0L</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (triggerInstCode == CompletedExecutionInstruction.SET_TRIGGER_COMPLETE) &#123;</span><br><span class="line">            getDelegate().updateTriggerState(conn, trigger.getKey(),</span><br><span class="line">                    STATE_COMPLETE);</span><br><span class="line">            signalSchedulingChangeOnTxCompletion(<span class="number">0L</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (triggerInstCode == CompletedExecutionInstruction.SET_TRIGGER_ERROR) &#123;</span><br><span class="line">            getLog().info(<span class="string">"Trigger "</span> + trigger.getKey() + <span class="string">" set to ERROR state."</span>);</span><br><span class="line">            getDelegate().updateTriggerState(conn, trigger.getKey(),</span><br><span class="line">                    STATE_ERROR);</span><br><span class="line">            signalSchedulingChangeOnTxCompletion(<span class="number">0L</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (triggerInstCode == CompletedExecutionInstruction.SET_ALL_JOB_TRIGGERS_COMPLETE) &#123;</span><br><span class="line">            getDelegate().updateTriggerStatesForJob(conn,</span><br><span class="line">                    trigger.getJobKey(), STATE_COMPLETE);</span><br><span class="line">            signalSchedulingChangeOnTxCompletion(<span class="number">0L</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (triggerInstCode == CompletedExecutionInstruction.SET_ALL_JOB_TRIGGERS_ERROR) &#123;</span><br><span class="line">            getLog().info(<span class="string">"All triggers of Job "</span> +</span><br><span class="line">                    trigger.getKey() + <span class="string">" set to ERROR state."</span>);</span><br><span class="line">            getDelegate().updateTriggerStatesForJob(conn,</span><br><span class="line">                    trigger.getJobKey(), STATE_ERROR);</span><br><span class="line">            signalSchedulingChangeOnTxCompletion(<span class="number">0L</span>);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (jobDetail.isConcurrentExectionDisallowed()) &#123;</span><br><span class="line">            <span class="comment">// 更新定时任务到WAITING状态</span></span><br><span class="line">            getDelegate().updateTriggerStatesForJobFromOtherState(conn,</span><br><span class="line">                    jobDetail.getKey(), STATE_WAITING,</span><br><span class="line">                    STATE_BLOCKED);</span><br><span class="line"> </span><br><span class="line">            getDelegate().updateTriggerStatesForJobFromOtherState(conn,</span><br><span class="line">                    jobDetail.getKey(), STATE_PAUSED,</span><br><span class="line">                    STATE_PAUSED_BLOCKED);</span><br><span class="line"> </span><br><span class="line">            signalSchedulingChangeOnTxCompletion(<span class="number">0L</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (jobDetail.isPersistJobDataAfterExecution()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (jobDetail.getJobDataMap().isDirty()) &#123;</span><br><span class="line">                    getDelegate().updateJobData(conn, jobDetail);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> JobPersistenceException(</span><br><span class="line">                        <span class="string">"Couldn't serialize job data: "</span> + e.getMessage(), e);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> JobPersistenceException(</span><br><span class="line">                        <span class="string">"Couldn't update job data: "</span> + e.getMessage(), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> JobPersistenceException(</span><br><span class="line">                <span class="string">"Couldn't update trigger state(s): "</span> + e.getMessage(), e);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 删除fired_triggers数据</span></span><br><span class="line">        getDelegate().deleteFiredTrigger(conn, trigger.getFireInstanceId());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> JobPersistenceException(<span class="string">"Couldn't delete fired trigger: "</span></span><br><span class="line">                + e.getMessage(), e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 锁实现，事务实现</span></span><br><span class="line"><span class="keyword">protected</span> &lt;T&gt; <span class="function">T <span class="title">executeInNonManagedTXLock</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        String lockName,</span></span></span><br><span class="line"><span class="function"><span class="params">        TransactionCallback&lt;T&gt; txCallback, <span class="keyword">final</span> TransactionValidator&lt;T&gt; txValidator)</span> <span class="keyword">throws</span> JobPersistenceException </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> transOwner = <span class="keyword">false</span>;</span><br><span class="line">    Connection conn = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (lockName != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// If we aren't using db locks, then delay getting DB connection</span></span><br><span class="line">            <span class="comment">// until after acquiring the lock since it isn't needed.</span></span><br><span class="line">            <span class="keyword">if</span> (getLockHandler().requiresConnection()) &#123;</span><br><span class="line">                conn = getNonManagedTXConnection();</span><br><span class="line">            &#125;</span><br><span class="line">             </span><br><span class="line">            transOwner = getLockHandler().obtainLock(conn, lockName);</span><br><span class="line">        &#125;</span><br><span class="line">         </span><br><span class="line">        <span class="keyword">if</span> (conn == <span class="keyword">null</span>) &#123;</span><br><span class="line">            conn = getNonManagedTXConnection();</span><br><span class="line">        &#125;</span><br><span class="line">         </span><br><span class="line">        <span class="keyword">final</span> T result = txCallback.execute(conn);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            commitConnection(conn);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JobPersistenceException e) &#123;</span><br><span class="line">            rollbackConnection(conn);</span><br><span class="line">            <span class="keyword">if</span> (txValidator == <span class="keyword">null</span> || !retryExecuteInNonManagedTXLock(lockName, <span class="keyword">new</span> TransactionCallback&lt;Boolean&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> Boolean <span class="title">execute</span><span class="params">(Connection conn)</span> <span class="keyword">throws</span> JobPersistenceException </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> txValidator.validate(conn, result);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> e;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        Long sigTime = clearAndGetSignalSchedulingChangeOnTxCompletion();</span><br><span class="line">        <span class="keyword">if</span>(sigTime != <span class="keyword">null</span> &amp;&amp; sigTime &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            signalSchedulingChangeImmediately(sigTime);</span><br><span class="line">        &#125;</span><br><span class="line">         </span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (JobPersistenceException e) &#123;</span><br><span class="line">        rollbackConnection(conn);</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">        rollbackConnection(conn);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> JobPersistenceException(<span class="string">"Unexpected runtime exception: "</span></span><br><span class="line">                + e.getMessage(), e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            releaseLock(lockName, transOwner);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            cleanupConnection(conn);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><figcaption><span>DBSemaphore.java</span></figcaption><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setExpandedSQL</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (getTablePrefix() != <span class="keyword">null</span> &amp;&amp; getSchedName() != <span class="keyword">null</span> &amp;&amp; sql != <span class="keyword">null</span> &amp;&amp; insertSql != <span class="keyword">null</span>) &#123;</span><br><span class="line">        expandedSQL = Util.rtp(<span class="keyword">this</span>.sql, getTablePrefix(), getSchedulerNameLiteral());</span><br><span class="line">        expandedInsertSQL = Util.rtp(<span class="keyword">this</span>.insertSql, getTablePrefix(), getSchedulerNameLiteral());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 获取锁</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">obtainLock</span><span class="params">(Connection conn, String lockName)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> LockException </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span>(log.isDebugEnabled()) &#123;</span><br><span class="line">        log.debug(</span><br><span class="line">            <span class="string">"Lock '"</span> + lockName + <span class="string">"' is desired by: "</span></span><br><span class="line">                    + Thread.currentThread().getName());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!isLockOwner(lockName)) &#123;</span><br><span class="line">         </span><br><span class="line">        <span class="comment">// 执行获取锁的方式</span></span><br><span class="line">        executeSQL(conn, lockName, expandedSQL, expandedInsertSQL);</span><br><span class="line">         </span><br><span class="line">        <span class="keyword">if</span>(log.isDebugEnabled()) &#123;</span><br><span class="line">            log.debug(</span><br><span class="line">                <span class="string">"Lock '"</span> + lockName + <span class="string">"' given to: "</span></span><br><span class="line">                        + Thread.currentThread().getName());</span><br><span class="line">        &#125;</span><br><span class="line">        getThreadLocks().add(lockName);</span><br><span class="line">        <span class="comment">//getThreadLocksObtainer().put(lockName, new</span></span><br><span class="line">        <span class="comment">// Exception("Obtainer..."));</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(log.isDebugEnabled()) &#123;</span><br><span class="line">        log.debug(</span><br><span class="line">            <span class="string">"Lock '"</span> + lockName + <span class="string">"' Is already owned by: "</span></span><br><span class="line">                    + Thread.currentThread().getName());</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><figcaption><span>StdRowLockSemaphore.java</span></figcaption><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SELECT_FOR_LOCK = <span class="string">"SELECT * FROM "</span></span><br><span class="line">        + TABLE_PREFIX_SUBST + TABLE_LOCKS + <span class="string">" WHERE "</span> + COL_SCHEDULER_NAME + <span class="string">" = "</span> + SCHED_NAME_SUBST</span><br><span class="line">        + <span class="string">" AND "</span> + COL_LOCK_NAME + <span class="string">" = ? FOR UPDATE"</span>;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String INSERT_LOCK = <span class="string">"INSERT INTO "</span></span><br><span class="line">    + TABLE_PREFIX_SUBST + TABLE_LOCKS + <span class="string">"("</span> + COL_SCHEDULER_NAME + <span class="string">", "</span> + COL_LOCK_NAME + <span class="string">") VALUES ("</span></span><br><span class="line">    + SCHED_NAME_SUBST + <span class="string">", ?)"</span>;</span><br><span class="line"> </span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">executeSQL</span><span class="params">(Connection conn, <span class="keyword">final</span> String lockName, <span class="keyword">final</span> String expandedSQL, <span class="keyword">final</span> String expandedInsertSQL)</span> <span class="keyword">throws</span> LockException </span>&#123;</span><br><span class="line">    PreparedStatement ps = <span class="keyword">null</span>;</span><br><span class="line">    ResultSet rs = <span class="keyword">null</span>;</span><br><span class="line">    SQLException initCause = <span class="keyword">null</span>;</span><br><span class="line">     </span><br><span class="line">    <span class="comment">// attempt lock two times (to work-around possible race conditions in inserting the lock row the first time running)</span></span><br><span class="line">    <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        count++;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 执行for update语句</span></span><br><span class="line">            ps = conn.prepareStatement(expandedSQL);</span><br><span class="line">            ps.setString(<span class="number">1</span>, lockName);</span><br><span class="line">             </span><br><span class="line">            <span class="keyword">if</span> (getLog().isDebugEnabled()) &#123;</span><br><span class="line">                getLog().debug(</span><br><span class="line">                    <span class="string">"Lock '"</span> + lockName + <span class="string">"' is being obtained: "</span> +</span><br><span class="line">                    Thread.currentThread().getName());</span><br><span class="line">            &#125;</span><br><span class="line">            rs = ps.executeQuery();</span><br><span class="line"> </span><br><span class="line">            <span class="comment">// 影响找不到</span></span><br><span class="line">            <span class="keyword">if</span> (!rs.next()) &#123;</span><br><span class="line">                getLog().debug(</span><br><span class="line">                        <span class="string">"Inserting new lock row for lock: '"</span> + lockName + <span class="string">"' being obtained by thread: "</span> +</span><br><span class="line">                        Thread.currentThread().getName());</span><br><span class="line">                rs.close();</span><br><span class="line">                rs = <span class="keyword">null</span>;</span><br><span class="line">                ps.close();</span><br><span class="line">                ps = <span class="keyword">null</span>;</span><br><span class="line">                <span class="comment">// 插入锁</span></span><br><span class="line">                ps = conn.prepareStatement(expandedInsertSQL);</span><br><span class="line">                ps.setString(<span class="number">1</span>, lockName);</span><br><span class="line"> </span><br><span class="line">                <span class="keyword">int</span> res = ps.executeUpdate();</span><br><span class="line">                 </span><br><span class="line">                <span class="keyword">if</span>(res != <span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span>(count &lt; <span class="number">3</span>) &#123;</span><br><span class="line">                        <span class="comment">// pause a bit to give another thread some time to commit the insert of the new lock row</span></span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            Thread.sleep(<span class="number">1000L</span>);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (InterruptedException ignore) &#123;</span><br><span class="line">                            Thread.currentThread().interrupt();</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// try again ...</span></span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                 </span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> SQLException(Util.rtp(</span><br><span class="line">                        <span class="string">"No row exists, and one could not be inserted in table "</span> + TABLE_PREFIX_SUBST + TABLE_LOCKS +</span><br><span class="line">                        <span class="string">" for lock named: "</span> + lockName, getTablePrefix(), getSchedulerNameLiteral()));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">             </span><br><span class="line">            <span class="comment">// 加锁成功，直接返回</span></span><br><span class="line">            <span class="keyword">return</span>; <span class="comment">// obtained lock, go</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException sqle) &#123;</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">if</span>(initCause == <span class="keyword">null</span>)</span><br><span class="line">                initCause = sqle;</span><br><span class="line">             </span><br><span class="line">            <span class="keyword">if</span> (getLog().isDebugEnabled()) &#123;</span><br><span class="line">                getLog().debug(</span><br><span class="line">                    <span class="string">"Lock '"</span> + lockName + <span class="string">"' was not obtained by: "</span> +</span><br><span class="line">                    Thread.currentThread().getName() + (count &lt; <span class="number">3</span> ? <span class="string">" - will try again."</span> : <span class="string">""</span>));</span><br><span class="line">            &#125;</span><br><span class="line">             </span><br><span class="line">            <span class="keyword">if</span>(count &lt; <span class="number">3</span>) &#123;</span><br><span class="line">                <span class="comment">// pause a bit to give another thread some time to commit the insert of the new lock row</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000L</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException ignore) &#123;</span><br><span class="line">                    Thread.currentThread().interrupt();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// try again ...</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">             </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LockException(<span class="string">"Failure obtaining db row lock: "</span></span><br><span class="line">                    + sqle.getMessage(), sqle);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (rs != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    rs.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception ignore) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (ps != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    ps.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception ignore) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span>(count &lt; <span class="number">4</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 循环4次加锁</span></span><br><span class="line">     </span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> LockException(<span class="string">"Failure obtaining db row lock, reached maximum number of attempts. Initial exception (if any) attached as root cause."</span>, initCause);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><figcaption><span>QuartzSchedulerThead.java</span></figcaption><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> lastAcquireFailed = <span class="keyword">false</span>;</span><br><span class="line">     </span><br><span class="line">    <span class="comment">// 无限循环调用</span></span><br><span class="line">    <span class="keyword">while</span> (!halted.get()) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// check if we're supposed to pause...</span></span><br><span class="line">            <span class="keyword">synchronized</span> (sigLock) &#123;</span><br><span class="line">                <span class="keyword">while</span> (paused &amp;&amp; !halted.get()) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="comment">// wait until togglePause(false) is called...</span></span><br><span class="line">                        sigLock.wait(<span class="number">1000L</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException ignore) &#123;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"> </span><br><span class="line">                <span class="keyword">if</span> (halted.get()) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">             </span><br><span class="line">            <span class="comment">// 当前可用的线程数量</span></span><br><span class="line">            <span class="keyword">int</span> availThreadCount = qsRsrcs.getThreadPool().blockForAvailableThreads();</span><br><span class="line">            <span class="keyword">if</span>(availThreadCount &gt; <span class="number">0</span>) &#123; <span class="comment">// will always be true, due to semantics of blockForAvailableThreads...</span></span><br><span class="line"> </span><br><span class="line">                List&lt;OperableTrigger&gt; triggers = <span class="keyword">null</span>;</span><br><span class="line"> </span><br><span class="line">                <span class="keyword">long</span> now = System.currentTimeMillis();</span><br><span class="line"> </span><br><span class="line">                clearSignaledSchedulingChange();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 获取即将执行的定时任务</span></span><br><span class="line">                    triggers = qsRsrcs.getJobStore().acquireNextTriggers(</span><br><span class="line">                            now + idleWaitTime, Math.min(availThreadCount, qsRsrcs.getMaxBatchSize()), qsRsrcs.getBatchTimeWindow());</span><br><span class="line">                    lastAcquireFailed = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">if</span> (log.isDebugEnabled())</span><br><span class="line">                        log.debug(<span class="string">"batch acquisition of "</span> + (triggers == <span class="keyword">null</span> ? <span class="number">0</span> : triggers.size()) + <span class="string">" triggers"</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (JobPersistenceException jpe) &#123;</span><br><span class="line">                    <span class="keyword">if</span>(!lastAcquireFailed) &#123;</span><br><span class="line">                        qs.notifySchedulerListenersError(</span><br><span class="line">                            <span class="string">"An error occurred while scanning for the next triggers to fire."</span>,</span><br><span class="line">                            jpe);</span><br><span class="line">                    &#125;</span><br><span class="line">                    lastAcquireFailed = <span class="keyword">true</span>;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">                    <span class="keyword">if</span>(!lastAcquireFailed) &#123;</span><br><span class="line">                        getLog().error(<span class="string">"quartzSchedulerThreadLoop: RuntimeException "</span></span><br><span class="line">                                +e.getMessage(), e);</span><br><span class="line">                    &#125;</span><br><span class="line">                    lastAcquireFailed = <span class="keyword">true</span>;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                 </span><br><span class="line">                <span class="comment">// 是否需要放弃此次定时任务</span></span><br><span class="line">                <span class="keyword">if</span> (triggers != <span class="keyword">null</span> &amp;&amp; !triggers.isEmpty()) &#123;</span><br><span class="line"> </span><br><span class="line">                    now = System.currentTimeMillis();</span><br><span class="line">                    <span class="keyword">long</span> triggerTime = triggers.get(<span class="number">0</span>).getNextFireTime().getTime();</span><br><span class="line">                    <span class="keyword">long</span> timeUntilTrigger = triggerTime - now;</span><br><span class="line">                    <span class="keyword">while</span>(timeUntilTrigger &gt; <span class="number">2</span>) &#123;</span><br><span class="line">                        <span class="keyword">synchronized</span> (sigLock) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (halted.get()) &#123;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">if</span> (!isCandidateNewTimeEarlierWithinReason(triggerTime, <span class="keyword">false</span>)) &#123;</span><br><span class="line">                                <span class="keyword">try</span> &#123;</span><br><span class="line">                                    <span class="comment">// we could have blocked a long while</span></span><br><span class="line">                                    <span class="comment">// on 'synchronize', so we must recompute</span></span><br><span class="line">                                    now = System.currentTimeMillis();</span><br><span class="line">                                    timeUntilTrigger = triggerTime - now;</span><br><span class="line">                                    <span class="keyword">if</span>(timeUntilTrigger &gt;= <span class="number">1</span>)</span><br><span class="line">                                        sigLock.wait(timeUntilTrigger);</span><br><span class="line">                                &#125; <span class="keyword">catch</span> (InterruptedException ignore) &#123;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span>(releaseIfScheduleChangedSignificantly(triggers, triggerTime)) &#123;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        now = System.currentTimeMillis();</span><br><span class="line">                        timeUntilTrigger = triggerTime - now;</span><br><span class="line">                    &#125;</span><br><span class="line"> </span><br><span class="line">                    <span class="comment">// this happens if releaseIfScheduleChangedSignificantly decided to release triggers</span></span><br><span class="line">                    <span class="keyword">if</span>(triggers.isEmpty())</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line"> </span><br><span class="line">                    <span class="comment">// set triggers to 'executing'</span></span><br><span class="line">                    List&lt;TriggerFiredResult&gt; bndles = <span class="keyword">new</span> ArrayList&lt;TriggerFiredResult&gt;();</span><br><span class="line"> </span><br><span class="line">                    <span class="keyword">boolean</span> goAhead = <span class="keyword">true</span>;</span><br><span class="line">                    <span class="keyword">synchronized</span>(sigLock) &#123;</span><br><span class="line">                        goAhead = !halted.get();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span>(goAhead) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="comment">// 将数据库状体改为正在执行</span></span><br><span class="line">                            List&lt;TriggerFiredResult&gt; res = qsRsrcs.getJobStore().triggersFired(triggers);</span><br><span class="line">                            <span class="keyword">if</span>(res != <span class="keyword">null</span>)</span><br><span class="line">                                bndles = res;</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (SchedulerException se) &#123;</span><br><span class="line">                            qs.notifySchedulerListenersError(</span><br><span class="line">                                    <span class="string">"An error occurred while firing triggers '"</span></span><br><span class="line">                                            + triggers + <span class="string">"'"</span>, se);</span><br><span class="line">                            <span class="comment">//QTZ-179 : a problem occurred interacting with the triggers from the db</span></span><br><span class="line">                            <span class="comment">//we release them and loop again</span></span><br><span class="line">                            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; triggers.size(); i++) &#123;</span><br><span class="line">                                qsRsrcs.getJobStore().releaseAcquiredTrigger(triggers.get(i));</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"> </span><br><span class="line">                    &#125;</span><br><span class="line"> </span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; bndles.size(); i++) &#123;</span><br><span class="line">                        TriggerFiredResult result =  bndles.get(i);</span><br><span class="line">                        TriggerFiredBundle bndle =  result.getTriggerFiredBundle();</span><br><span class="line">                        Exception exception = result.getException();</span><br><span class="line"> </span><br><span class="line">                        <span class="keyword">if</span> (exception <span class="keyword">instanceof</span> RuntimeException) &#123;</span><br><span class="line">                            getLog().error(<span class="string">"RuntimeException while firing trigger "</span> + triggers.get(i), exception);</span><br><span class="line">                            qsRsrcs.getJobStore().releaseAcquiredTrigger(triggers.get(i));</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"> </span><br><span class="line">                        <span class="comment">// it's possible to get 'null' if the triggers was paused,</span></span><br><span class="line">                        <span class="comment">// blocked, or other similar occurrences that prevent it being</span></span><br><span class="line">                        <span class="comment">// fired at this time...  or if the scheduler was shutdown (halted)</span></span><br><span class="line">                        <span class="keyword">if</span> (bndle == <span class="keyword">null</span>) &#123;</span><br><span class="line">                            qsRsrcs.getJobStore().releaseAcquiredTrigger(triggers.get(i));</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"> </span><br><span class="line">                        JobRunShell shell = <span class="keyword">null</span>;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="comment">// 创建定时任务的执行脚本</span></span><br><span class="line">                            shell = qsRsrcs.getJobRunShellFactory().createJobRunShell(bndle);</span><br><span class="line">                            shell.initialize(qs);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (SchedulerException se) &#123;</span><br><span class="line">                            qsRsrcs.getJobStore().triggeredJobComplete(triggers.get(i), bndle.getJobDetail(), CompletedExecutionInstruction.SET_ALL_JOB_TRIGGERS_ERROR);</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                     </span><br><span class="line">                        <span class="comment">// 将当前的JobRunShell加入线程池，基本上永远成功</span></span><br><span class="line">                        <span class="keyword">if</span> (qsRsrcs.getThreadPool().runInThread(shell) == <span class="keyword">false</span>) &#123;</span><br><span class="line">                            <span class="comment">// this case should never happen, as it is indicative of the</span></span><br><span class="line">                            <span class="comment">// scheduler being shutdown or a bug in the thread pool or</span></span><br><span class="line">                            <span class="comment">// a thread pool being used concurrently - which the docs</span></span><br><span class="line">                            <span class="comment">// say not to do...</span></span><br><span class="line">                            getLog().error(<span class="string">"ThreadPool.runInThread() return false!"</span>);</span><br><span class="line">                             </span><br><span class="line">                            qsRsrcs.getJobStore().triggeredJobComplete(triggers.get(i), bndle.getJobDetail(), CompletedExecutionInstruction.SET_ALL_JOB_TRIGGERS_ERROR);</span><br><span class="line">                        &#125;</span><br><span class="line"> </span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 循环执行</span></span><br><span class="line">                    <span class="keyword">continue</span>; <span class="comment">// while (!halted)</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123; <span class="comment">// if(availThreadCount &gt; 0)</span></span><br><span class="line">                <span class="comment">// should never happen, if threadPool.blockForAvailableThreads() follows contract</span></span><br><span class="line">                <span class="keyword">continue</span>; <span class="comment">// while (!halted)</span></span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">long</span> now = System.currentTimeMillis();</span><br><span class="line">            <span class="keyword">long</span> waitTime = now + getRandomizedIdleWaitTime();</span><br><span class="line">            <span class="keyword">long</span> timeUntilContinue = waitTime - now;</span><br><span class="line">            <span class="keyword">synchronized</span>(sigLock) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                  <span class="keyword">if</span>(!halted.get()) &#123;</span><br><span class="line">                    <span class="comment">// QTZ-336 A job might have been completed in the mean time and we might have</span></span><br><span class="line">                    <span class="comment">// missed the scheduled changed signal by not waiting for the notify() yet</span></span><br><span class="line">                    <span class="comment">// Check that before waiting for too long in case this very job needs to be</span></span><br><span class="line">                    <span class="comment">// scheduled very soon</span></span><br><span class="line">                    <span class="keyword">if</span> (!isScheduleChanged()) &#123;</span><br><span class="line">                      sigLock.wait(timeUntilContinue);</span><br><span class="line">                    &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException ignore) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">        &#125; <span class="keyword">catch</span>(RuntimeException re) &#123;</span><br><span class="line">            getLog().error(<span class="string">"Runtime error occurred in main trigger firing loop."</span>, re);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="comment">// while (!halted)</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">// drop references to scheduler stuff to aid garbage collection...</span></span><br><span class="line">    qs = <span class="keyword">null</span>;</span><br><span class="line">    qsRsrcs = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><figcaption><span>JobRunShell.java</span></figcaption><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    qs.addInternalSchedulerListener(<span class="keyword">this</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        OperableTrigger trigger = (OperableTrigger) jec.getTrigger();</span><br><span class="line">        JobDetail jobDetail = jec.getJobDetail();</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line"> </span><br><span class="line">            JobExecutionException jobExEx = <span class="keyword">null</span>;</span><br><span class="line">            Job job = jec.getJobInstance();</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                begin();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (SchedulerException se) &#123;</span><br><span class="line">                qs.notifySchedulerListenersError(<span class="string">"Error executing Job ("</span></span><br><span class="line">                        + jec.getJobDetail().getKey()</span><br><span class="line">                        + <span class="string">": couldn't begin execution."</span>, se);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            <span class="comment">// notify job &amp; trigger listeners...</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!notifyListenersBeginning(jec)) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span>(VetoedException ve) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    CompletedExecutionInstruction instCode = trigger.executionComplete(jec, <span class="keyword">null</span>);</span><br><span class="line">                    qs.notifyJobStoreJobVetoed(trigger, jobDetail, instCode);</span><br><span class="line">                     </span><br><span class="line">                    <span class="comment">// QTZ-205</span></span><br><span class="line">                    <span class="comment">// Even if trigger got vetoed, we still needs to check to see if it's the trigger's finalized run or not.</span></span><br><span class="line">                    <span class="keyword">if</span> (jec.getTrigger().getNextFireTime() == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        qs.notifySchedulerListenersFinalized(jec.getTrigger());</span><br><span class="line">                    &#125;</span><br><span class="line"> </span><br><span class="line">                    complete(<span class="keyword">true</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (SchedulerException se) &#123;</span><br><span class="line">                    qs.notifySchedulerListenersError(<span class="string">"Error during veto of Job ("</span></span><br><span class="line">                            + jec.getJobDetail().getKey()</span><br><span class="line">                            + <span class="string">": couldn't finalize execution."</span>, se);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 记录开始结束时间</span></span><br><span class="line">            <span class="keyword">long</span> startTime = System.currentTimeMillis();</span><br><span class="line">            <span class="keyword">long</span> endTime = startTime;</span><br><span class="line"> </span><br><span class="line">            <span class="comment">// execute the job</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                log.debug(<span class="string">"Calling execute on job "</span> + jobDetail.getKey());</span><br><span class="line">                <span class="comment">// 调用定时任务具体方法</span></span><br><span class="line">                job.execute(jec);</span><br><span class="line">                endTime = System.currentTimeMillis();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (JobExecutionException jee) &#123;</span><br><span class="line">                endTime = System.currentTimeMillis();</span><br><span class="line">                jobExEx = jee;</span><br><span class="line">                getLog().info(<span class="string">"Job "</span> + jobDetail.getKey() +</span><br><span class="line">                        <span class="string">" threw a JobExecutionException: "</span>, jobExEx);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                endTime = System.currentTimeMillis();</span><br><span class="line">                getLog().error(<span class="string">"Job "</span> + jobDetail.getKey() +</span><br><span class="line">                        <span class="string">" threw an unhandled Exception: "</span>, e);</span><br><span class="line">                SchedulerException se = <span class="keyword">new</span> SchedulerException(</span><br><span class="line">                        <span class="string">"Job threw an unhandled exception."</span>, e);</span><br><span class="line">                qs.notifySchedulerListenersError(<span class="string">"Job ("</span></span><br><span class="line">                        + jec.getJobDetail().getKey()</span><br><span class="line">                        + <span class="string">" threw an exception."</span>, se);</span><br><span class="line">                jobExEx = <span class="keyword">new</span> JobExecutionException(se, <span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            log.info(<span class="string">"start record job log"</span>);</span><br><span class="line">            <span class="comment">//execute log</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                String currentIp = InetAddress.getLocalHost().getHostAddress();</span><br><span class="line">                <span class="comment">// 记录定时任务执行记录</span></span><br><span class="line">                qs.recordJobLog(jec.getTrigger(),startTime,endTime, currentIp);</span><br><span class="line">                log.info(<span class="string">"end record job log"</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</span><br><span class="line">                log.warn(<span class="string">"record execute log error"</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (SchedulerException e) &#123;</span><br><span class="line">                log.warn(<span class="string">"record execute log error"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            jec.setJobRunTime(endTime - startTime);</span><br><span class="line"> </span><br><span class="line">            <span class="comment">// notify all job listeners</span></span><br><span class="line">            <span class="keyword">if</span> (!notifyJobListenersComplete(jec, jobExEx)) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            CompletedExecutionInstruction instCode = CompletedExecutionInstruction.NOOP;</span><br><span class="line"> </span><br><span class="line">            <span class="comment">// update the trigger</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                instCode = trigger.executionComplete(jec, jobExEx);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="comment">// If this happens, there's a bug in the trigger...</span></span><br><span class="line">                SchedulerException se = <span class="keyword">new</span> SchedulerException(</span><br><span class="line">                        <span class="string">"Trigger threw an unhandled exception."</span>, e);</span><br><span class="line">                qs.notifySchedulerListenersError(</span><br><span class="line">                        <span class="string">"Please report this error to the Quartz developers."</span>,</span><br><span class="line">                        se);</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            <span class="comment">// notify all trigger listeners</span></span><br><span class="line">            <span class="keyword">if</span> (!notifyTriggerListenersComplete(jec, instCode)) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            <span class="comment">// update job/trigger or re-execute job</span></span><br><span class="line">            <span class="keyword">if</span> (instCode == CompletedExecutionInstruction.RE_EXECUTE_JOB) &#123;</span><br><span class="line">                jec.incrementRefireCount();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    complete(<span class="keyword">false</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (SchedulerException se) &#123;</span><br><span class="line">                    qs.notifySchedulerListenersError(<span class="string">"Error executing Job ("</span></span><br><span class="line">                            + jec.getJobDetail().getKey()</span><br><span class="line">                            + <span class="string">": couldn't finalize execution."</span>, se);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                complete(<span class="keyword">true</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (SchedulerException se) &#123;</span><br><span class="line">                qs.notifySchedulerListenersError(<span class="string">"Error executing Job ("</span></span><br><span class="line">                        + jec.getJobDetail().getKey()</span><br><span class="line">                        + <span class="string">": couldn't finalize execution."</span>, se);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            <span class="comment">// 完成定时任务</span></span><br><span class="line">            qs.notifyJobStoreJobComplete(trigger, jobDetail, instCode);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">while</span> (<span class="keyword">true</span>);</span><br><span class="line"> </span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        qs.removeInternalSchedulerListener(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
                <hr>
                

                <ul class="pager">
                    
                    
                    <li class="next">
                        <a href="/2017/03/03/2017-03-03-transaction/" data-toggle="tooltip" data-placement="top"
                           title="事务与并发">Next Post &rarr;</a>
                    </li>
                    
                </ul>

                

                


                <!--加入新的评论系统-->
                
            </div>

            <div class="hidden-xs col-sm-3 toc-col">
                <div class="toc-wrap">
                    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Quartz状态解析"><span class="toc-text">Quartz状态解析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#核心表解析"><span class="toc-text">核心表解析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Dubbo调度方式解析"><span class="toc-text">Dubbo调度方式解析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Quartz核心业务逻辑解析"><span class="toc-text">Quartz核心业务逻辑解析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#我们的优化"><span class="toc-text">我们的优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#核心代码解析"><span class="toc-text">核心代码解析</span></a></li></ol>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Sidebar Container -->

            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5 class="text-center">
                        <a href="/tags/">FEATURED TAGS</a>
                    </h5>
                    <div class="tags">
                        
                        <a class="tag" href="/tags/#Java"
                           title="Java">Java</a>
                        
                        <a class="tag" href="/tags/#quartz"
                           title="quartz">quartz</a>
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
                <div style="margin-top: 20px;">
                    <h5 class="text-center">FRIENDS</h5>
                    <ul class="list-inline text-center">
                        
                        <li><a href="https://go.ruitao.name">Google</a></li>
                        
                        <li><a href="http://idea.ruitao.name">IDEA激活</a></li>
                        
                    </ul>
                </div>
                
            </div>
        </div>

    </div>
</article>







<!-- Footer -->
<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 text-center">
                <br>
                <ul class="list-inline text-center">
                
                
                    <li>
                        <a target="_blank" href="https://twitter.com/wrt2011">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                
                
                    <li>
                        <a target="_blank" href="https://www.zhihu.com/people/happytao">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa  fa-stack-1x fa-inverse">知</i>
                            </span>
                        </a>
                    </li>
                

                
                    <li>
                        <a target="_blank" href="http://weibo.com/314121000">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                
                    <li>
                        <a target="_blank"  href="https://github.com/happy-tao">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; 陶陶滔滔涛 2018
                    <br>
                    <span id="busuanzi_container_site_pv" style="font-size: 12px;">PV: <span id="busuanzi_value_site_pv"></span> Times</span>
                    <br>
                    Theme by <a href="https://haojen.github.io/">Haojen Ma</a>
                </p>

            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="/js/blog.js"></script>

<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("http://ruitao.name/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("//cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>

<!-- Google Analytics -->


<script>
    // dynamic User by Hux
    var _gaId = 'UA-71854041-1';
    var _gaDomain = 'ruitao.name';
    // Originial
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>


<!-- Baidu Tongji -->


<!-- swiftype -->
<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
  (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
  e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install','','2.0.0');
</script>

<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<!--wechat title img-->
<img class="wechat-title-img" src="http://ww1.sinaimg.cn/large/4a77b961gy1fo6xl4hej6j20hs0hsdh5.jpg">
</body>

</html>
